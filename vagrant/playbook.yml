- hosts: all
  become: yes
  user: root
  vars:
    - mysql_root_password: password
    - mysql_user_name: vagrant
    - mysql_user_password: vagrant
    - mysql_database: fighter-curation

  tasks:
    - name: set timezone to Asia/Tokyo
      timezone:
        name: Asia/Tokyo

    - name: install epel
      yum:
        name: epel-release
        state: present

    - name: install remi repository
      yum:
        name: http://rpms.famillecollet.com/enterprise/remi-release-7.rpm
        state: present

    - name: install net-tools
      yum:
        name: net-tools
        state: present

    - name: install httpd
      yum:
        name: "{{ item }}"
        state: present
      with_items:
        - httpd
        - mod_ssl
        - mod_geoip

    - name: httpd.conf replace DocumentRoot
      replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^DocumentRoot "/var/www/html"'
        replace: DocumentRoot "/app/fighter-curation/public"
 
    - name: httpd.conf replace Directory
      replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: '^\<Directory "/var/www/html"\>'
        replace: <Directory "/app/fighter-curation/public">
 
    - name: httpd.conf replace AllowOverride
      replace:
        path: /etc/httpd/conf/httpd.conf
        regexp: 'AllowOverride None'
        replace: AllowOverride All

    - name: install php
      yum:
        name: "{{ item }}"
        state: present
        enablerepo: remi,remi-php72
      with_items:
        - php
        - php-devel
        - php-mbstring
        - php-pdo
        - php-xml
        - php-tokenizer
        - php-json
        - php-ctype
        - php-openssl
        - php-mysql

    - name: install composer
      shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin && mv /usr/bin/composer.phar /usr/bin/composer
         creates=/usr/bin/composer

    - name: install required module for laravel
      yum: 
        name: "{{ item }}"
        state: present
      with_items:
        - git
        - unzip

    - name: uninstall mariaDB
      yum:
        name: mariadb-libs
        state: absent

    - name: uninstall default mysql
      yum:
        name: mysql*
        state: absent

    - name: remove mariaDB date
      shell: rm -rf /var/lib/mysql

    - name: install rpm repository
      yum: 
        name: https://dev.mysql.com/get/mysql57-community-release-el6-11.noarch.rpm
        state: present

    - name: install mysql
      yum:
        name: "{{ item }}"
        enablerepo: mysql56-community
        disablerepo: mysql57-community
        state: present
      with_items:
        - mysql-community-server
        - mysql-community-client
        - mysql-community-common
        - mysql-community-libs
        - mysql-community-libs-compat
        - MySQL-python
        - libselinux-python

    - name: start mysqld 
      service:
        name: mysqld
        state: started
        enabled: yes

    - name: change root password
      mysql_user:
        name: root
        password: "{{ mysql_root_password }}"
        host: "{{ item }}"
      with_items:
        - 127.0.0.1
        - ::1
        - localhost.localdomain
        - localhost

    - name: /root/.my.cnf by template
      template: 
        src: my.cnf.j2
        dest: /root/.my.cnf
        owner: root
        group: root
        mode: 0600

    - name: create database
      mysql_db:
        name: "{{ mysql_database }}"
        state: present

    - name: add mysql user
      mysql_user:
        name: "{{mysql_user_name}}"
        password: "{{mysql_user_password}}"
        host: localhost
        priv: '{{ mysql_database }}.*:ALL,GRANT'

    - name: restart network
      service:
        name: network
        state: restarted
        enabled: yes

    - name: start httpd
      service:
        name: httpd
        state: started
        enabled: yes
